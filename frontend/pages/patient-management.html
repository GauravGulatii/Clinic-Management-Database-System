<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Management - Clinic Management System</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        .dashboard-container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        .main-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        .patient-header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .patient-info {
            display: flex;
            align-items: center;
        }

        .patient-avatar {
            width: 60px;
            height: 60px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: #666;
        }

        .patient-details h2 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .patient-details p {
            margin: 0;
            color: #666;
        }

        .back-btn {
            padding: 8px 15px;
            background: #f5f5f5;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #333;
        }

        .back-btn:hover {
            background: #e0e0e0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid;
            padding-bottom: 10px;
        }

        .action-list {
            list-style: none;
            padding: 0;
        }

        .action-list li {
            margin: 10px 0;
        }

        .action-btn {
            display: block;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-weight: 500;
        }

        /* Appointments buttons */
        .dashboard-card:nth-child(1) .action-btn {
            background: #4CAF50;
        }
        .dashboard-card:nth-child(1) .action-btn:hover {
            background: #388E3C;
        }

        /* Medical Records buttons */
        .dashboard-card:nth-child(2) .action-btn {
            background: #2196F3;
        }
        .dashboard-card:nth-child(2) .action-btn:hover {
            background: #1976D2;
        }

        /* Prescriptions buttons */
        .dashboard-card:nth-child(3) .action-btn {
            background: #9C27B0;
        }
        .dashboard-card:nth-child(3) .action-btn:hover {
            background: #7B1FA2;
        }

        .action-btn i {
            margin-right: 10px;
            width: 20px;
        }

        /* Matching header border colors */
        .dashboard-card:nth-child(1) h3 {
            border-color: #4CAF50;
        }
        .dashboard-card:nth-child(2) h3 {
            border-color: #2196F3;
        }
        .dashboard-card:nth-child(3) h3 {
            border-color: #9C27B0;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #2196F3;
            outline: none;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #388E3C;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .action-cell {
            text-align: center;
        }

        .action-btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }

        .view-btn {
            background: #2196F3;
            color: white;
        }

        .edit-btn {
            background: #4CAF50;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-hospital-symbol"></i>
                <h2>Staff Portal</h2>
            </div>
            <ul class="nav-links">
                <li>
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </li>
                <li class="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <header>
                <h1 id="welcome-header">Patient Management</h1>
            </header>

            <!-- Patient Header -->
            <div class="patient-header">
                <div class="patient-info">
                    <div class="patient-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="patient-details">
                        <h2 id="patient-name">Loading...</h2>
                        <p>ID: <span id="patient-id">Loading...</span> | Age: <span id="patient-age">Loading...</span></p>
                    </div>
                </div>
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Appointments Management -->
                <div class="dashboard-card">
                    <h3>Appointments</h3>
                    <ul class="action-list">
                        <li>
                            <button class="action-btn" onclick="showSection('appointments')">
                                <i class="fas fa-calendar-check"></i>
                                View Appointments
                            </button>
                        </li>
                        <li>
                            <button class="action-btn" onclick="showSection('createAppointment')">
                                <i class="fas fa-calendar-plus"></i>
                                Create Appointment
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Medical Records -->
                <div class="dashboard-card">
                    <h3>Medical Records</h3>
                    <ul class="action-list">
                        <li>
                            <button class="action-btn" onclick="showSection('medicalRecords')">
                                <i class="fas fa-file-medical"></i>
                                View Records
                            </button>
                        </li>
                        <li>
                            <button class="action-btn" onclick="showSection('createRecord')">
                                <i class="fas fa-file-medical-alt"></i>
                                Create Record
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Prescriptions -->
                <div class="dashboard-card">
                    <h3>Prescriptions</h3>
                    <ul class="action-list">
                        <li>
                            <button class="action-btn" onclick="showSection('prescriptions')">
                                <i class="fas fa-prescription"></i>
                                View Prescriptions
                            </button>
                        </li>
                        <li>
                            <button class="action-btn" onclick="showSection('createPrescription')">
                                <i class="fas fa-prescription-bottle"></i>
                                Create Prescription
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Billing -->
                <div class="dashboard-card">
                    <h3>Billing</h3>
                    <ul class="action-list">
                        <li>
                            <button class="action-btn" onclick="showSection('billing')">
                                <i class="fas fa-file-invoice-dollar"></i>
                                View Billing
                            </button>
                        </li>
                        <li>
                            <button class="action-btn" onclick="showSection('createBilling')">
                                <i class="fas fa-plus-circle"></i>
                                Create Billing
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Content Sections -->
            <!-- Appointments Section -->
            <div id="appointments" class="content-section">
                <div class="section-header">
                    <h2>Appointments</h2>
                    <button class="close-btn" onclick="hideSection('appointments')">&times;</button>
                </div>
                <div id="appointments-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Appointment ID</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Doctor</th>
                                <th>Staff ID</th>
                                <th class="action-cell">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appointments-table-body">
                            <!-- Appointments will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create Appointment Section -->
            <div id="createAppointment" class="content-section">
                <div class="section-header">
                    <h2>Create Appointment</h2>
                    <button class="close-btn" onclick="hideSection('createAppointment')">&times;</button>
                </div>
                <form id="appointment-form">
                    <div class="form-group">
                        <label for="appointment-date">Date</label>
                        <input type="date" id="appointment-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="appointment-time">Time</label>
                        <select id="appointment-time" class="form-control" required>
                            <option value="">Select a time</option>
                            <option value="08:00">8:00 AM</option>
                            <option value="08:30">8:30 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="09:30">9:30 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="12:30">12:30 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="13:30">1:30 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="14:30">2:30 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="15:30">3:30 PM</option>
                            <option value="16:00">4:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointment-doctor">Doctor</label>
                        <select id="appointment-doctor" class="form-control" required>
                            <option value="">Select a doctor</option>
                            <!-- Doctors will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointment-staff">Staff ID</label>
                        <input type="text" id="appointment-staff" class="form-control" value="S001" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Appointment</button>
                </form>
            </div>

            <!-- Medical Records Section -->
            <div id="medicalRecords" class="content-section">
                <div class="section-header">
                    <h2>Medical Records</h2>
                    <button class="close-btn" onclick="hideSection('medicalRecords')">&times;</button>
                </div>
                <div id="records-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Record ID</th>
                                <th>Diagnosis</th>
                                <th>Treatment</th>
                                <th>Appointment ID</th>
                                <th class="action-cell">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body">
                            <!-- Medical records will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create Medical Record Section -->
            <div id="createRecord" class="content-section">
                <div class="section-header">
                    <h2>Create Medical Record</h2>
                    <button class="close-btn" onclick="hideSection('createRecord')">&times;</button>
                </div>
                <form id="record-form">
                    <div class="form-group">
                        <label for="record-date">Date</label>
                        <input type="date" id="record-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="record-doctor">Doctor</label>
                        <select id="record-doctor" class="form-control" required>
                            <option value="">Select a doctor</option>
                            <!-- Doctors will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="record-appointment">Appointment</label>
                        <select id="record-appointment" class="form-control">
                            <option value="">Select an appointment (optional)</option>
                            <!-- Appointments will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="record-diagnosis">Diagnosis</label>
                        <textarea id="record-diagnosis" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="record-treatment">Treatment</label>
                        <textarea id="record-treatment" class="form-control" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Record</button>
                </form>
            </div>

            <!-- Prescriptions Section -->
            <div id="prescriptions" class="content-section">
                <div class="section-header">
                    <h2>Prescriptions</h2>
                    <button class="close-btn" onclick="hideSection('prescriptions')">&times;</button>
                </div>
                <div id="prescriptions-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Prescription ID</th>
                                <th>Medication</th>
                                <th>Dosage</th>
                                <th>Appointment ID</th>
                                <th class="action-cell">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prescriptions-table-body">
                            <!-- Prescriptions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create Prescription Section -->
            <div id="createPrescription" class="content-section">
                <div class="section-header">
                    <h2>Create Prescription</h2>
                    <button class="close-btn" onclick="hideSection('createPrescription')">&times;</button>
                </div>
                <form id="prescription-form">
                    <div class="form-group">
                        <label for="prescription-date">Date</label>
                        <input type="date" id="prescription-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="prescription-doctor">Doctor</label>
                        <select id="prescription-doctor" class="form-control" required>
                            <option value="">Select a doctor</option>
                            <!-- Doctors will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prescription-appointment">Appointment</label>
                        <select id="prescription-appointment" class="form-control">
                            <option value="">Select an appointment (optional)</option>
                            <!-- Appointments will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prescription-medication">Medication</label>
                        <input type="text" id="prescription-medication" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="prescription-dosage">Dosage</label>
                        <input type="text" id="prescription-dosage" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Prescription</button>
                </form>
            </div>

            <!-- Billing Section -->
            <div id="billing" class="content-section">
                <div class="section-header">
                    <h2>Billing Records</h2>
                    <button class="close-btn" onclick="hideSection('billing')">&times;</button>
                </div>
                <div id="billing-list">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Billing ID</th>
                                <th>Amount</th>
                                <th>Payment Status</th>
                                <th>Appointment ID</th>
                                <th>Staff ID</th>
                                <th class="action-cell">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billing-table-body">
                            <!-- Billing records will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create Billing Section -->
            <div id="createBilling" class="content-section">
                <div class="section-header">
                    <h2>Create Billing Record</h2>
                    <button class="close-btn" onclick="hideSection('createBilling')">&times;</button>
                </div>
                <form id="billing-form">
                    <div class="form-group">
                        <label for="billing-amount">Amount</label>
                        <input type="number" id="billing-amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="billing-appointment">Appointment</label>
                        <select id="billing-appointment" class="form-control" required>
                            <option value="">Select an appointment</option>
                            <!-- Appointments will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="billing-staff">Staff ID</label>
                        <input type="text" id="billing-staff" class="form-control" value="S001" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Billing Record</button>
                </form>
            </div>
        </main>
    </div>
    
    <script>
        // Get patient ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('id');
        
        // Get staff ID from sessionStorage
        const staffId = sessionStorage.getItem('currentStaffId');
        
        // Mock data for testing
        const mockPatients = [
            {
                id: '12345678',
                firstName: 'John',
                lastName: 'Doe',
                dateOfBirth: '1985-01-15',
                sex: 'Male',
                phone: '(555) 123-4567',
                address: '123 Main St, Anytown, USA'
            },
            {
                id: '87654321',
                firstName: 'Jane',
                lastName: 'Smith',
                dateOfBirth: '1990-05-22',
                sex: 'Female',
                phone: '(555) 987-6543',
                address: '456 Oak Ave, Somewhere, USA'
            }
        ];

        const mockDoctors = [
            { 
                id: 'D001', 
                name: 'Dr. Smith', 
                specialization: 'General Medicine',
                availability: 'Mon-Fri, 9AM-5PM'
            },
            { 
                id: 'D002', 
                name: 'Dr. Johnson', 
                specialization: 'Cardiology',
                availability: 'Mon-Thu, 10AM-6PM'
            },
            { 
                id: 'D003', 
                name: 'Dr. Williams', 
                specialization: 'Pediatrics',
                availability: 'Tue-Sat, 8AM-4PM'
            }
        ];

        // Mock appointments data
        const mockAppointments = [
            {
                id: 'A001',
                patientId: '12345678',
                doctorId: 'D001',
                date: '2023-06-15',
                time: '10:00',
                reason: 'Annual checkup',
                status: 'Completed',
                billingStatus: 'Paid',
                staffId: 'S001'
            },
            {
                id: 'A002',
                patientId: '12345678',
                doctorId: 'D002',
                date: '2023-05-10',
                time: '14:30',
                reason: 'Follow-up',
                status: 'Completed',
                billingStatus: 'Unpaid',
                staffId: 'S001'
            },
            {
                id: 'A003',
                patientId: '12345678',
                doctorId: 'D003',
                date: '2023-08-05',
                time: '09:15',
                reason: 'Consultation',
                status: 'Scheduled',
                billingStatus: 'Unpaid',
                staffId: 'S001'
            }
        ];

        // Mock medical records data
        const mockMedicalRecords = [
            {
                id: 'R001',
                patientId: '12345678',
                doctorId: 'D001',
                date: '2023-06-15',
                diagnosis: 'Hypertension',
                treatment: 'Prescribed medication and lifestyle changes',
                appointmentId: 'A001'
            },
            {
                id: 'R002',
                patientId: '12345678',
                doctorId: 'D002',
                date: '2023-05-10',
                diagnosis: 'Common cold',
                treatment: 'Prescribed rest and over-the-counter medication',
                appointmentId: 'A002'
            }
        ];

        // Mock prescriptions data
        const mockPrescriptions = [
            {
                id: 'P001',
                patientId: '12345678',
                doctorId: 'D001',
                date: '2023-06-15',
                medication: 'Lisinopril',
                dosage: '10mg daily',
                instructions: 'Take once daily with food',
                status: 'Filled',
                billingStatus: 'Paid',
                appointmentId: 'A001'
            },
            {
                id: 'P002',
                patientId: '12345678',
                doctorId: 'D002',
                date: '2023-05-10',
                medication: 'Amoxicillin',
                dosage: '500mg twice daily',
                instructions: 'Take with water, complete full course',
                status: 'Pending',
                billingStatus: 'Unpaid',
                appointmentId: 'A002'
            }
        ];

        // Mock billing data
        const mockBilling = [
            {
                id: 'B001',
                patientId: '12345678',
                amount: 150.00,
                paymentStatus: 'Paid',
                appointmentId: 'A001',
                staffId: 'S001',
                date: '2023-06-15'
            },
            {
                id: 'B002',
                patientId: '12345678',
                amount: 75.50,
                paymentStatus: 'Unpaid',
                appointmentId: 'A002',
                staffId: 'S001',
                date: '2023-07-20'
            }
        ];

        // Store mock data in localStorage if not already present
        if (!localStorage.getItem('patients')) {
            localStorage.setItem('patients', JSON.stringify(mockPatients));
        }
        if (!localStorage.getItem('appointments')) {
            localStorage.setItem('appointments', JSON.stringify(mockAppointments));
        }
        if (!localStorage.getItem('medicalRecords')) {
            localStorage.setItem('medicalRecords', JSON.stringify(mockMedicalRecords));
        }
        if (!localStorage.getItem('prescriptions')) {
            localStorage.setItem('prescriptions', JSON.stringify(mockPrescriptions));
        }
        if (!localStorage.getItem('billing')) {
            localStorage.setItem('billing', JSON.stringify(mockBilling));
        }
        
        // Redirect to login if no staff ID is found
        if (!staffId) {
            window.location.href = '../index.html';
        }

        // Redirect to dashboard if no patient ID is found
        if (!patientId) {
            window.location.href = 'staff-dashboard.html';
        }

        // Add event listeners for navigation
        document.querySelector('.nav-links li:first-child').addEventListener('click', function() {
            window.location.href = 'staff-dashboard.html';
        });

        document.querySelector('.nav-links li.logout').addEventListener('click', function() {
            if (confirm('Are you sure you want to log out?')) {
                sessionStorage.removeItem('currentStaffId');
                window.location.href = '../index.html';
            }
        });

        // Load patient data
        function loadPatientData() {
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            const patient = patients.find(p => p.id === patientId);
            
            if (patient) {
                document.getElementById('patient-name').textContent = `${patient.firstName} ${patient.lastName}`;
                document.getElementById('patient-id').textContent = patient.id;
                document.getElementById('patient-age').textContent = calculateAge(patient.dateOfBirth);
            } else {
                alert('Patient not found');
                window.location.href = 'staff-dashboard.html';
            }
        }

        // Load doctor options in dropdowns
        function loadDoctorOptions() {
            const doctorSelects = [
                document.getElementById('appointment-doctor'),
                document.getElementById('record-doctor'),
                document.getElementById('prescription-doctor')
            ];
            
            doctorSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select a doctor</option>';
                    mockDoctors.forEach(doctor => {
                        select.innerHTML += `<option value="${doctor.id}">${doctor.name} (${doctor.specialization})</option>`;
                    });
                }
            });
        }

        // Load appointment options for medical records, prescriptions, and billing
        function loadAppointmentOptions() {
            const appointmentSelects = [
                document.getElementById('record-appointment'),
                document.getElementById('prescription-appointment'),
                document.getElementById('billing-appointment')
            ];
            
            appointmentSelects.forEach(select => {
                if (select) {
                    const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
                    const patientAppointments = appointments.filter(a => a.patientId === patientId);
                    
                    select.innerHTML = '<option value="">Select an appointment' + (select.id === 'billing-appointment' ? '' : ' (optional)') + '</option>';
                    patientAppointments.forEach(appointment => {
                        const doctor = mockDoctors.find(d => d.id === appointment.doctorId);
                        const doctorName = doctor ? doctor.name : 'Unknown';
                        select.innerHTML += `<option value="${appointment.id}">${appointment.date} ${appointment.time} - ${doctorName}</option>`;
                    });
                }
            });
        }

        // Load appointments
        function loadAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const patientAppointments = appointments.filter(a => a.patientId === patientId);
            const tableBody = document.getElementById('appointments-table-body');
            
            if (patientAppointments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No appointments found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = patientAppointments.map(appointment => {
                const doctor = mockDoctors.find(d => d.id === appointment.doctorId);
                const isPaid = appointment.billingStatus === 'Paid';
                return `
                    <tr>
                        <td>${appointment.id}</td>
                        <td>${appointment.date}</td>
                        <td>${appointment.time}</td>
                        <td>${doctor ? doctor.name : 'Unknown'}</td>
                        <td>${appointment.staffId || 'N/A'}</td>
                        <td class="action-cell">
                            <button class="action-btn-small view-btn" onclick="viewAppointment('${appointment.id}')">View</button>
                            <button class="action-btn-small edit-btn" onclick="editAppointment('${appointment.id}')">Edit</button>
                            <button class="action-btn-small ${isPaid ? 'btn-danger' : 'btn-success'}" onclick="togglePaymentStatus('${appointment.id}')">
                                ${isPaid ? 'Mark Unpaid' : 'Mark Paid'}
                            </button>
                            <button class="action-btn-small delete-btn" onclick="deleteAppointment('${appointment.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load medical records
        function loadMedicalRecords() {
            const records = JSON.parse(localStorage.getItem('medicalRecords')) || [];
            const patientRecords = records.filter(r => r.patientId === patientId);
            const tableBody = document.getElementById('records-table-body');
            
            if (patientRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No medical records found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = patientRecords.map(record => {
                return `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.diagnosis}</td>
                        <td>${record.treatment}</td>
                        <td>${record.appointmentId || 'N/A'}</td>
                        <td class="action-cell">
                            <button class="action-btn-small view-btn" onclick="viewRecord('${record.id}')">View</button>
                            <button class="action-btn-small edit-btn" onclick="editRecord('${record.id}')">Edit</button>
                            <button class="action-btn-small delete-btn" onclick="deleteRecord('${record.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load prescriptions
        function loadPrescriptions() {
            const prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            const patientPrescriptions = prescriptions.filter(p => p.patientId === patientId);
            const tableBody = document.getElementById('prescriptions-table-body');
            
            if (patientPrescriptions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No prescriptions found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = patientPrescriptions.map(prescription => {
                const isPaid = prescription.billingStatus === 'Paid';
                return `
                    <tr>
                        <td>${prescription.id}</td>
                        <td>${prescription.medication}</td>
                        <td>${prescription.dosage}</td>
                        <td>${prescription.appointmentId || 'N/A'}</td>
                        <td class="action-cell">
                            <button class="action-btn-small view-btn" onclick="viewPrescription('${prescription.id}')">View</button>
                            <button class="action-btn-small edit-btn" onclick="editPrescription('${prescription.id}')">Edit</button>
                            <button class="action-btn-small ${isPaid ? 'btn-danger' : 'btn-success'}" onclick="togglePrescriptionPaymentStatus('${prescription.id}')">
                                ${isPaid ? 'Mark Unpaid' : 'Mark Paid'}
                            </button>
                            <button class="action-btn-small delete-btn" onclick="deletePrescription('${prescription.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load billing records
        function loadBilling() {
            const billingRecords = JSON.parse(localStorage.getItem('billing')) || [];
            const patientBilling = billingRecords.filter(b => b.patientId === patientId);
            const tableBody = document.getElementById('billing-table-body');
            
            if (patientBilling.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No billing records found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = patientBilling.map(bill => {
                const isPaid = bill.paymentStatus === 'Paid';
                return `
                    <tr>
                        <td>${bill.id}</td>
                        <td>$${bill.amount.toFixed(2)}</td>
                        <td>${bill.paymentStatus}</td>
                        <td>${bill.appointmentId || 'N/A'}</td>
                        <td>${bill.staffId}</td>
                        <td class="action-cell">
                            <button class="action-btn-small view-btn" onclick="viewBilling('${bill.id}')">View</button>
                            <button class="action-btn-small edit-btn" onclick="editBilling('${bill.id}')">Edit</button>
                            <button class="action-btn-small ${isPaid ? 'btn-danger' : 'btn-success'}" onclick="toggleBillingPaymentStatus('${bill.id}')">
                                ${isPaid ? 'Mark Unpaid' : 'Mark Paid'}
                            </button>
                            <button class="action-btn-small delete-btn" onclick="deleteBilling('${bill.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Show a section
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // Hide a section
        function hideSection(sectionId) {
            document.getElementById(sectionId).classList.remove('active');
        }

        // Go back to dashboard
        function goBack() {
            window.location.href = 'staff-dashboard.html';
        }

        // Calculate age from date of birth
        function calculateAge(dateOfBirth) {
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Form submission handlers
        document.getElementById('appointment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const date = document.getElementById('appointment-date').value;
            const time = document.getElementById('appointment-time').value;
            const doctorId = document.getElementById('appointment-doctor').value;
            const staffId = document.getElementById('appointment-staff').value;
            
            // Create a new appointment
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const newAppointmentId = 'A' + (appointments.length + 1).toString().padStart(3, '0');
            
            const newAppointment = {
                id: newAppointmentId,
                patientId: patientId,
                doctorId: doctorId,
                date: date,
                time: time,
                status: 'Scheduled',
                billingStatus: 'Unpaid',
                staffId: staffId
            };
            
            appointments.push(newAppointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            alert('Appointment created successfully!');
            hideSection('createAppointment');
            loadAppointments(); // Refresh the appointments table
        });

        document.getElementById('record-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const appointmentId = document.getElementById('record-appointment').value;
            alert(`Medical record created successfully${appointmentId ? ' and linked to appointment ' + appointmentId : ''}!`);
            hideSection('createRecord');
        });

        document.getElementById('prescription-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const appointmentId = document.getElementById('prescription-appointment').value;
            alert(`Prescription created successfully${appointmentId ? ' and linked to appointment ' + appointmentId : ''}!`);
            hideSection('createPrescription');
        });

        document.getElementById('billing-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const appointmentId = document.getElementById('billing-appointment').value;
            const amount = document.getElementById('billing-amount').value;
            const staffId = document.getElementById('billing-staff').value;
            
            // Create a new billing record
            const billingRecords = JSON.parse(localStorage.getItem('billing')) || [];
            const newBillingId = 'B' + (billingRecords.length + 1).toString().padStart(3, '0');
            
            const newBilling = {
                id: newBillingId,
                patientId: patientId,
                amount: parseFloat(amount),
                paymentStatus: 'Unpaid', // Default to Unpaid
                appointmentId: appointmentId,
                staffId: staffId,
                date: new Date().toISOString().split('T')[0]
            };
            
            billingRecords.push(newBilling);
            localStorage.setItem('billing', JSON.stringify(billingRecords));
            
            alert(`Billing record created successfully and linked to appointment ${appointmentId}!`);
            hideSection('createBilling');
            loadBilling(); // Refresh the billing table
        });

        // View, edit, and delete functions (placeholders)
        function viewAppointment(id) {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const appointment = appointments.find(a => a.id === id);
            
            if (appointment) {
                const doctor = mockDoctors.find(d => d.id === appointment.doctorId);
                const doctorName = doctor ? doctor.name : 'Unknown';
                alert(`Appointment ID: ${appointment.id}\nDate: ${appointment.date}\nTime: ${appointment.time}\nDoctor: ${doctorName}\nStatus: ${appointment.status}\nStaff ID: ${appointment.staffId || 'N/A'}`);
            }
        }

        function editAppointment(id) {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const appointmentIndex = appointments.findIndex(a => a.id === id);
            
            if (appointmentIndex !== -1) {
                const appointment = appointments[appointmentIndex];
                
                // Create a form for editing
                const date = prompt('Enter date (YYYY-MM-DD):', appointment.date);
                if (date === null) return; // User cancelled
                
                const time = prompt('Enter time (HH:MM):', appointment.time);
                if (time === null) return; // User cancelled
                
                const staffId = prompt('Enter staff ID:', appointment.staffId || 'S001');
                if (staffId === null) return; // User cancelled
                
                // Update the appointment
                appointments[appointmentIndex].date = date;
                appointments[appointmentIndex].time = time;
                appointments[appointmentIndex].staffId = staffId;
                
                // Save to localStorage
                localStorage.setItem('appointments', JSON.stringify(appointments));
                
                // Refresh the table
                loadAppointments();
                
                alert('Appointment updated successfully!');
            }
        }

        function deleteAppointment(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                alert(`Appointment ${id} deleted`);
            }
        }

        function viewRecord(id) {
            const records = JSON.parse(localStorage.getItem('medicalRecords')) || [];
            const record = records.find(r => r.id === id);
            
            if (record) {
                alert(`Record ID: ${record.id}\nDiagnosis: ${record.diagnosis}\nTreatment: ${record.treatment}\nAppointment ID: ${record.appointmentId || 'N/A'}`);
            }
        }

        function editRecord(id) {
            const records = JSON.parse(localStorage.getItem('medicalRecords')) || [];
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex !== -1) {
                const record = records[recordIndex];
                
                // Create a form for editing
                const diagnosis = prompt('Enter diagnosis:', record.diagnosis);
                if (diagnosis === null) return; // User cancelled
                
                const treatment = prompt('Enter treatment:', record.treatment);
                if (treatment === null) return; // User cancelled
                
                // Update the record
                records[recordIndex].diagnosis = diagnosis;
                records[recordIndex].treatment = treatment;
                
                // Save to localStorage
                localStorage.setItem('medicalRecords', JSON.stringify(records));
                
                // Refresh the table
                loadMedicalRecords();
                
                alert('Medical record updated successfully!');
            }
        }

        function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this medical record?')) {
                const records = JSON.parse(localStorage.getItem('medicalRecords')) || [];
                const updatedRecords = records.filter(r => r.id !== id);
                localStorage.setItem('medicalRecords', JSON.stringify(updatedRecords));
                loadMedicalRecords();
                alert(`Medical record ${id} deleted`);
            }
        }

        function viewPrescription(id) {
            alert(`View prescription ${id}`);
        }

        function editPrescription(id) {
            alert(`Edit prescription ${id}`);
        }

        function deletePrescription(id) {
            if (confirm('Are you sure you want to delete this prescription?')) {
                alert(`Prescription ${id} deleted`);
            }
        }

        // Toggle payment status
        function togglePaymentStatus(appointmentId) {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const appointmentIndex = appointments.findIndex(a => a.id === appointmentId);
            
            if (appointmentIndex !== -1) {
                const currentStatus = appointments[appointmentIndex].billingStatus;
                appointments[appointmentIndex].billingStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid';
                
                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadAppointments(); // Refresh the table
                
                const newStatus = appointments[appointmentIndex].billingStatus;
                alert(`Payment status for appointment ${appointmentId} has been updated to ${newStatus}`);
            }
        }

        // Toggle prescription payment status
        function togglePrescriptionPaymentStatus(prescriptionId) {
            const prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            const prescriptionIndex = prescriptions.findIndex(p => p.id === prescriptionId);
            
            if (prescriptionIndex !== -1) {
                const currentStatus = prescriptions[prescriptionIndex].billingStatus;
                prescriptions[prescriptionIndex].billingStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid';
                
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                loadPrescriptions(); // Refresh the table
                
                const newStatus = prescriptions[prescriptionIndex].billingStatus;
                alert(`Payment status for prescription ${prescriptionId} has been updated to ${newStatus}`);
            }
        }

        // Toggle billing payment status
        function toggleBillingPaymentStatus(billingId) {
            const billingRecords = JSON.parse(localStorage.getItem('billing')) || [];
            const billingIndex = billingRecords.findIndex(b => b.id === billingId);
            
            if (billingIndex !== -1) {
                const currentStatus = billingRecords[billingIndex].paymentStatus;
                billingRecords[billingIndex].paymentStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid';
                
                localStorage.setItem('billing', JSON.stringify(billingRecords));
                loadBilling(); // Refresh the table
                
                const newStatus = billingRecords[billingIndex].paymentStatus;
                alert(`Payment status for billing ${billingId} has been updated to ${newStatus}`);
            }
        }

        // View, edit, and delete billing functions
        function viewBilling(id) {
            const billingRecords = JSON.parse(localStorage.getItem('billing')) || [];
            const bill = billingRecords.find(b => b.id === id);
            
            if (bill) {
                alert(`Billing ID: ${bill.id}\nAmount: $${bill.amount.toFixed(2)}\nPayment Status: ${bill.paymentStatus}\nAppointment ID: ${bill.appointmentId || 'N/A'}\nStaff ID: ${bill.staffId}`);
            }
        }

        function editBilling(id) {
            const billingRecords = JSON.parse(localStorage.getItem('billing')) || [];
            const billingIndex = billingRecords.findIndex(b => b.id === id);
            
            if (billingIndex !== -1) {
                const bill = billingRecords[billingIndex];
                
                // Create a form for editing
                const amount = prompt('Enter amount:', bill.amount);
                if (amount === null) return; // User cancelled
                
                const paymentStatus = confirm('Is this bill paid?') ? 'Paid' : 'Unpaid';
                
                // Update the billing record
                billingRecords[billingIndex].amount = parseFloat(amount);
                billingRecords[billingIndex].paymentStatus = paymentStatus;
                
                // Save to localStorage
                localStorage.setItem('billing', JSON.stringify(billingRecords));
                
                // Refresh the table
                loadBilling();
                
                alert('Billing record updated successfully!');
            }
        }

        function deleteBilling(id) {
            if (confirm('Are you sure you want to delete this billing record?')) {
                const billingRecords = JSON.parse(localStorage.getItem('billing')) || [];
                const updatedBilling = billingRecords.filter(b => b.id !== id);
                localStorage.setItem('billing', JSON.stringify(updatedBilling));
                loadBilling();
                alert(`Billing record ${id} deleted`);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadPatientData();
            loadDoctorOptions();
            loadAppointmentOptions();
            loadAppointments();
            loadMedicalRecords();
            loadPrescriptions();
            loadBilling();
        });
    </script>
</body>
</html> 