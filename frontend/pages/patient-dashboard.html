<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - Clinic Management System</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        .dashboard-container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        .main-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(calc(33.333% - 20px), 1fr));
            gap: 20px;
            width: 100%;
        }
        
        .card {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 200px;
            overflow-y: auto;
        }
        
        .appointment-item {
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 0 5px 5px 0;
        }
        
        .appointment-item p {
            margin: 5px 0;
        }
        
        .status-scheduled {
            display: inline-block;
            padding: 3px 8px;
            background-color: #e8f5e9;
            color: #4CAF50;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-hospital-symbol"></i>
                <h2>Patient Portal</h2>
            </div>
            <ul class="nav-links">
                <li class="active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </li>
                <li>
                    <i class="fas fa-calendar-alt"></i>
                    <span>Book Appointment</span>
                </li>
                <li>
                    <i class="fas fa-history"></i>
                    <span>Appointment History</span>
                </li>
                <li>
                    <i class="fas fa-file-medical"></i>
                    <span>Medical Records</span>
                </li>
                <li>
                    <i class="fas fa-prescription"></i>
                    <span>Prescriptions</span>
                </li>
                <li>
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Billing</span>
                </li>
                <li class="profile">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </li>
                <li class="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <header>
                <h1 id="welcome-header">Welcome, <span id="username-display">Guest</span></h1>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="profile-name" class="profile-link">My Profile</span>
                </div>
            </header>

            <div class="dashboard-grid">
                <div class="card" id="next-appointment-card">
                    <h3>Upcoming Appointments</h3>
                    <div id="appointment-list">
                        <p>No upcoming appointments</p>
                    </div>
                    <button class="action-btn book-appointment-btn">Book New Appointment</button>
                </div>
                <div class="card">
                    <h3>Recent Prescriptions</h3>
                    <div id="prescription-list">
                        <!-- Prescription list will be populated by JavaScript -->
                    </div>
                    <button class="action-btn" id="view-prescriptions-btn">View All</button>
                </div>
                <div class="card">
                    <h3>Medical Records</h3>
                    <div id="medical-records-summary">
                        <!-- Medical records summary will be populated by JavaScript -->
                    </div>
                    <button class="action-btn" id="view-records-btn">View Records</button>
                </div>
                <div class="card">
                    <h3>Billing Status</h3>
                    <div id="billing-summary">
                        <!-- Billing summary will be populated by JavaScript -->
                    </div>
                    <button class="action-btn" id="view-billing-btn">View History</button>
                </div>
            </div>
        </main>
    </div>
    
    <script src="../pages/common.js"></script>
    <script>
        // Get current patient ID from sessionStorage
        const currentPatientId = sessionStorage.getItem('currentPatientId');
        
        // Redirect to login if no patient ID is found
        if (!currentPatientId) {
            window.location.href = '../index.html';
        }
        
        // Get patient data from localStorage
        function getCurrentPatient() {
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            return patients.find(p => p.id === currentPatientId) || null;
        }
        
        // Load patient data
        const currentPatient = getCurrentPatient();
        
        // Update welcome message and profile name
        if (currentPatient) {
            document.getElementById('username-display').textContent = currentPatient.firstName;
            document.getElementById('profile-name').textContent = `${currentPatient.firstName} ${currentPatient.lastName}`;
        }
        
        // Add event listeners for navigation
        document.querySelectorAll('.book-appointment-btn').forEach(button => {
            button.addEventListener('click', () => window.location.href = 'book-appointment.html');
        });
        
        document.querySelector('.nav-links li:nth-child(1)').addEventListener('click', function() {
            window.location.href = 'patient-dashboard.html';
        });
        
        document.querySelector('.nav-links li:nth-child(2)').addEventListener('click', function() {
            window.location.href = 'book-appointment.html';
        });
        
        document.querySelector('.nav-links li:nth-child(3)').addEventListener('click', function() {
            window.location.href = 'appointment-history.html';
        });
        
        document.querySelector('.nav-links li:nth-child(4)').addEventListener('click', function() {
            window.location.href = 'medical-records.html';
        });
        
        document.querySelector('.nav-links li:nth-child(5)').addEventListener('click', function() {
            window.location.href = 'prescriptions.html';
        });
        
        document.querySelector('.nav-links li:nth-child(6)').addEventListener('click', function() {
            window.location.href = 'billing.html';
        });
        
        document.querySelector('.nav-links li.logout').addEventListener('click', function() {
            if (confirm('Are you sure you want to log out?')) {
                window.location.href = '../index.html';
            }
        });
        
        document.querySelector('.nav-links li.profile').addEventListener('click', function() {
            window.location.href = 'profile.html';
        });
        
        // Display upcoming appointments
        function displayUpcomingAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const appointmentList = document.getElementById('appointment-list');
            
            if (appointments.length === 0) {
                appointmentList.innerHTML = '<p>No upcoming appointments</p>';
                return;
            }
            
            // Sort and filter appointments
            const today = new Date();
            const upcomingAppointments = appointments
                .filter(appointment => new Date(appointment.date + 'T' + appointment.time) >= today)
                .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            
            if (upcomingAppointments.length === 0) {
                appointmentList.innerHTML = '<p>No upcoming appointments</p>';
                return;
            }
            
            // Display appointments
            appointmentList.innerHTML = '';
            upcomingAppointments.slice(0, 3).forEach(appointment => {
                const appointmentItem = document.createElement('div');
                appointmentItem.className = 'appointment-item';
                
                // Get appointment type text
                const typeMap = {
                    'general': 'General Checkup',
                    'specialist': 'Specialist Consultation',
                    'followup': 'Follow-up Visit',
                    'emergency': 'Urgent Care'
                };
                
                appointmentItem.innerHTML = `
                    <p><strong>${appointment.formattedDate}</strong></p>
                    <p>${appointment.formattedTime}</p>
                    <p>${appointment.doctorName}</p>
                    <p>${typeMap[appointment.type] || appointment.type}</p>
                    <p><span class="status-scheduled">Scheduled</span></p>
                `;
                
                appointmentList.appendChild(appointmentItem);
            });
            
            if (upcomingAppointments.length > 3) {
                const moreAppointments = document.createElement('p');
                moreAppointments.textContent = `+ ${upcomingAppointments.length - 3} more appointments`;
                moreAppointments.style.textAlign = 'center';
                moreAppointments.style.fontStyle = 'italic';
                appointmentList.appendChild(moreAppointments);
            }
        }
        
        // Mock prescription data
        const mockPrescriptions = [
            {
                id: 'rx-001',
                medication: 'Amoxicillin',
                dosage: '500mg',
                frequency: 'Three times daily',
                duration: '7 days',
                doctor: 'Dr. Smith',
                date: '2023-06-15',
                refills: 0,
                status: 'Active'
            },
            {
                id: 'rx-002',
                medication: 'Lisinopril',
                dosage: '10mg',
                frequency: 'Once daily',
                duration: '30 days',
                doctor: 'Dr. Johnson',
                date: '2023-05-20',
                refills: 2,
                status: 'Active'
            },
            {
                id: 'rx-003',
                medication: 'Ibuprofen',
                dosage: '400mg',
                frequency: 'As needed',
                duration: '10 days',
                doctor: 'Dr. Williams',
                date: '2023-04-10',
                refills: 0,
                status: 'Expired'
            }
        ];
        
        // Store mock prescriptions in localStorage if not already present
        if (!localStorage.getItem('prescriptions')) {
            localStorage.setItem('prescriptions', JSON.stringify(mockPrescriptions));
        }
        
        // Display recent prescriptions
        function displayRecentPrescriptions() {
            const prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            const prescriptionList = document.getElementById('prescription-list');
            
            if (prescriptions.length === 0) {
                prescriptionList.innerHTML = '<p>No recent prescriptions</p>';
                return;
            }
            
            // Sort prescriptions by date (newest first)
            prescriptions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Display up to 2 most recent prescriptions
            prescriptionList.innerHTML = '';
            prescriptions.slice(0, 2).forEach(prescription => {
                const prescriptionItem = document.createElement('div');
                prescriptionItem.className = 'prescription-item';
                
                const formattedDate = new Date(prescription.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                prescriptionItem.innerHTML = `
                    <p><strong>${prescription.medication}</strong> ${prescription.dosage}</p>
                    <p>${prescription.frequency}</p>
                    <p>Prescribed: ${formattedDate}</p>
                    <p><span class="status-${prescription.status.toLowerCase()}">${prescription.status}</span></p>
                `;
                
                prescriptionList.appendChild(prescriptionItem);
            });
            
            if (prescriptions.length > 2) {
                const morePrescriptions = document.createElement('p');
                morePrescriptions.textContent = `+ ${prescriptions.length - 2} more prescriptions`;
                morePrescriptions.style.textAlign = 'center';
                morePrescriptions.style.fontStyle = 'italic';
                prescriptionList.appendChild(morePrescriptions);
            }
        }
        
        // Mock medical records data
        const mockMedicalRecords = [
            {
                id: 'mr-001',
                type: 'Lab Test',
                name: 'Complete Blood Count (CBC)',
                date: '2023-05-10',
                doctor: 'Dr. Smith',
                results: 'Normal',
                notes: 'All values within normal range.'
            },
            {
                id: 'mr-002',
                type: 'Imaging',
                name: 'Chest X-Ray',
                date: '2023-04-15',
                doctor: 'Dr. Johnson',
                results: 'Normal',
                notes: 'No abnormalities detected.'
            },
            {
                id: 'mr-003',
                type: 'Vaccination',
                name: 'Influenza Vaccine',
                date: '2023-03-20',
                doctor: 'Dr. Williams',
                results: 'Completed',
                notes: 'Annual flu vaccination administered.'
            },
            {
                id: 'mr-004',
                type: 'Physical Examination',
                name: 'Annual Checkup',
                date: '2023-02-05',
                doctor: 'Dr. Smith',
                results: 'Completed',
                notes: 'Patient in good health. Blood pressure slightly elevated, recommended lifestyle changes.'
            }
        ];
        
        // Store mock medical records in localStorage if not already present
        if (!localStorage.getItem('medicalRecords')) {
            localStorage.setItem('medicalRecords', JSON.stringify(mockMedicalRecords));
        }
        
        // Display medical records summary
        function displayMedicalRecordsSummary() {
            const medicalRecords = JSON.parse(localStorage.getItem('medicalRecords')) || [];
            const medicalRecordsSummary = document.getElementById('medical-records-summary');
            
            if (medicalRecords.length === 0) {
                medicalRecordsSummary.innerHTML = '<p>No medical records available</p>';
                return;
            }
            
            // Sort records by date (newest first)
            medicalRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get the most recent record
            const latestRecord = medicalRecords[0];
            
            // Format date
            const formattedDate = new Date(latestRecord.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            medicalRecordsSummary.innerHTML = `
                <p><strong>Last updated:</strong> ${formattedDate}</p>
                <p><strong>Recent record:</strong> ${latestRecord.name}</p>
                <p><strong>Type:</strong> ${latestRecord.type}</p>
            `;
        }
        
        // Mock billing data
        const mockBillingData = [
            {
                id: 'bill-001',
                date: '2023-05-15',
                description: 'General Checkup',
                amount: 150.00,
                insurance: 120.00,
                patientResponsibility: 30.00,
                status: 'Paid',
                paymentDate: '2023-05-20'
            },
            {
                id: 'bill-002',
                date: '2023-04-10',
                description: 'Blood Test',
                amount: 200.00,
                insurance: 160.00,
                patientResponsibility: 40.00,
                status: 'Pending',
                dueDate: '2023-06-10'
            },
            {
                id: 'bill-003',
                date: '2023-03-05',
                description: 'X-Ray',
                amount: 300.00,
                insurance: 240.00,
                patientResponsibility: 60.00,
                status: 'Paid',
                paymentDate: '2023-03-15'
            }
        ];
        
        // Store mock billing data in localStorage if not already present
        if (!localStorage.getItem('billingData')) {
            localStorage.setItem('billingData', JSON.stringify(mockBillingData));
        }
        
        // Display billing summary
        function displayBillingSummary() {
            const billingData = JSON.parse(localStorage.getItem('billingData')) || [];
            const billingSummary = document.getElementById('billing-summary');
            
            if (billingData.length === 0) {
                billingSummary.innerHTML = '<p>No billing information available</p>';
                return;
            }
            
            // Check for pending bills
            const pendingBills = billingData.filter(bill => bill.status === 'Pending');
            
            if (pendingBills.length === 0) {
                billingSummary.innerHTML = '<p>No pending bills</p>';
                return;
            }
            
            // Calculate total pending amount
            const totalPending = pendingBills.reduce((total, bill) => total + bill.patientResponsibility, 0);
            
            // Display pending bills summary
            billingSummary.innerHTML = `
                <p><strong>Pending Bills:</strong> ${pendingBills.length}</p>
                <p><strong>Total Due:</strong> $${totalPending.toFixed(2)}</p>
                <p><strong>Next Due Date:</strong> ${new Date(pendingBills[0].dueDate).toLocaleDateString()}</p>
            `;
        }
        
        // Call functions to display data
        displayUpcomingAppointments();
        displayRecentPrescriptions();
        displayMedicalRecordsSummary();
        displayBillingSummary();

        document.getElementById('profile-name').addEventListener('click', function() {
            window.location.href = 'profile.html';
        });
    </script>
</body>
</html> 